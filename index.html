<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: black;
    overflow: hidden;
    font-family: system-ui, sans-serif;
  }

  video {
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    background: black;
  }

  #recordButton {
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%);
    width: 90px;
    height: 90px;
    border-radius: 50%;
    background: #dc2626;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #recordButton::after {
    content: "";
    width: 60px;
    height: 60px;
    background: white;
    border-radius: 50%;
  }

  svg {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) rotate(-90deg);
    pointer-events: none;
  }

  #actions {
    position: fixed;
    bottom: 140px;
    left: 50%;
    transform: translateX(-50%);
    display: none;
    gap: 12px;
  }

  #actions button {
    padding: 10px 16px;
    font-size: 14px;
    border-radius: 8px;
    border: none;
  }

  #shareBtn {
    background: #2563eb;
    color: white;
  }

  #downloadBtn {
    background: #374151;
    color: white;
  }
</style>

<video id="camera" autoplay muted playsinline></video>

<svg width="120" height="120">
  <circle cx="60" cy="60" r="52"
    stroke="#ffffff55" stroke-width="6" fill="none" />
  <circle id="progress"
    cx="60" cy="60" r="52"
    stroke="#dc2626" stroke-width="6" fill="none"
    stroke-linecap="round"
    stroke-dasharray="326.7"
    stroke-dashoffset="326.7" />
</svg>

<div id="recordButton"></div>

<div id="actions">
  <button id="shareBtn">Share</button>
  <button id="downloadBtn">Download</button>
</div>

<script>
(() => {
  const video = document.getElementById("camera");
  const recordBtn = document.getElementById("recordButton");
  const ring = document.getElementById("progress");
  const actions = document.getElementById("actions");
  const shareBtn = document.getElementById("shareBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  const MAX_TIME = 15000;
  const CIRC = 326.7;

  let stream;
  let recorder;
  let chunks = [];
  let recordedBlob;
  let timer;
  let startTime;

  async function initCamera() {
    if (stream) return stream;

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" },
      audio: true
    });

    video.srcObject = stream;
    return stream;
  }

  function updateRing(elapsed) {
    const p = Math.min(elapsed / MAX_TIME, 1);
    ring.style.strokeDashoffset = CIRC * (1 - p);
  }

  function downloadVideo() {
    const url = URL.createObjectURL(recordedBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "video-15s.webm";
    a.click();
    URL.revokeObjectURL(url);
  }

  async function tryShare(file) {
    if (!navigator.canShare || !navigator.canShare({ files: [file] })) {
      return false;
    }
    try {
      await navigator.share({
        title: "My video",
        files: [file]
      });
      return true;
    } catch {
      return false;
    }
  }

  async function startRecording() {
    await initCamera();

    actions.style.display = "none";
    chunks = [];
    ring.style.strokeDashoffset = CIRC;
    recordBtn.style.pointerEvents = "none";

    recorder = new MediaRecorder(stream);
    recorder.ondataavailable = e => e.data.size && chunks.push(e.data);

    recorder.onstop = async () => {
      clearInterval(timer);

      recordedBlob = new Blob(chunks, { type: recorder.mimeType });
      const file = new File([recordedBlob], "video-15s.webm", {
        type: recordedBlob.type
      });

      const shared = await tryShare(file);

      if (!shared) {
        actions.style.display = "flex";
      }

      recordBtn.style.pointerEvents = "auto";
      ring.style.strokeDashoffset = CIRC;
    };

    recorder.start();
    startTime = Date.now();

    timer = setInterval(() => {
      updateRing(Date.now() - startTime);
    }, 50);

    setTimeout(() => recorder.stop(), MAX_TIME);
  }

  recordBtn.addEventListener("click", startRecording);
  shareBtn.addEventListener("click", () => tryShare(
    new File([recordedBlob], "video-15s.webm", { type: recordedBlob.type })
  ));
  downloadBtn.addEventListener("click", downloadVideo);
})();
</script>
