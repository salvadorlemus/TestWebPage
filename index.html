<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, viewport-fit=cover" />
<title>Vertical Video Recorder</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  width: 100%;
  height: 100%;
  overflow: hidden;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

#camera {
  position: fixed;
  inset: 0;
  object-fit: cover;
  width: 100vw;
  height: 100vh;
}

#controls {
  position: fixed;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;
}

#recordButton {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: red;
  position: relative;
  border: none;
}

#progressRing {
  position: absolute;
  inset: -6px;
  border-radius: 50%;
  border: 6px solid rgba(255,255,255,0.3);
}

#progressFill {
  position: absolute;
  inset: -6px;
  border-radius: 50%;
  border: 6px solid white;
  clip-path: inset(0 0 100% 0);
}

#actions {
  display: none;
  gap: 12px;
}

button.action {
  background: white;
  color: black;
  padding: 10px 16px;
  border-radius: 6px;
  border: none;
  font-size: 14px;
}
</style>
</head>

<body>

<video id="camera" playsinline muted></video>

<div id="controls">
  <button id="recordButton">
    <div id="progressRing"></div>
    <div id="progressFill"></div>
  </button>

  <div id="actions">
    <button class="action" id="saveBtn">Save</button>
    <button class="action" id="shareBtn">Share</button>
  </div>
</div>

<script>
const MAX_DURATION = 15000;

const video = document.getElementById("camera");
const recordBtn = document.getElementById("recordButton");
const progressFill = document.getElementById("progressFill");
const actions = document.getElementById("actions");
const saveBtn = document.getElementById("saveBtn");
const shareBtn = document.getElementById("shareBtn");

let mediaRecorder;
let recordedChunks = [];
let recordedBlob;
let startTime;
let rafId;

recordBtn.addEventListener("click", async () => {
  if (!mediaRecorder) {
    await lockOrientation();
    await initCamera();
    startRecording();
  }
});

async function lockOrientation() {
  if (screen.orientation && screen.orientation.lock) {
    try {
      await screen.orientation.lock("portrait");
    } catch (_) {
      // iOS Safari ignores this â€” expected behavior
    }
  }
}

async function initCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: {
      facingMode: "user",
      width: { ideal: 720 },
      height: { ideal: 1280 },
      aspectRatio: 9 / 16
    },
    audio: true
  });

  video.srcObject = stream;
  await video.play();

  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
  mediaRecorder.onstop = onRecordingStop;
}

function startRecording() {
  recordedChunks = [];
  mediaRecorder.start();
  startTime = performance.now();
  updateProgress();
  setTimeout(stopRecording, MAX_DURATION);
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
    cancelAnimationFrame(rafId);
  }
}

function updateProgress() {
  const elapsed = performance.now() - startTime;
  const progress = Math.min(elapsed / MAX_DURATION, 1);
  progressFill.style.clipPath = `inset(${(1 - progress) * 100}% 0 0 0)`;

  if (progress < 1) {
    rafId = requestAnimationFrame(updateProgress);
  }
}

function onRecordingStop() {
  recordedBlob = new Blob(recordedChunks, { type: mediaRecorder.mimeType });
  actions.style.display = "flex";
}

function saveToDevice() {
  const url = URL.createObjectURL(recordedBlob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "video-15s.mp4";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function shareVideo() {
  const file = new File([recordedBlob], "video.mp4", { type: recordedBlob.type });

  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    await navigator.share({
      files: [file],
      title: "My video"
    });
  } else {
    alert("Sharing not supported. Please download the video and upload it inside the app.");
  }
}

saveBtn.addEventListener("click", saveToDevice);
shareBtn.addEventListener("click", shareVideo);
</script>

</body>
</html>
